
<!DOCTYPE HTML>
<html>
<head>
	<script data-cfasync="false" type="text/javascript" src="//use.typekit.net/axj3cfp.js"></script>
	<script data-cfasync="false" type="text/javascript">try{Typekit.load();}catch(e){}</script>
	<meta charset="utf-8">
	<title>UnityでリアルタイムIBLしてみた  | UNICORN SQUARE GARDEN</title>

<meta name="author" content="kosakasakas"> 

<meta name="description" content="Unityでリアルタイムにイメージベースドライティング(割と疑似ですが。)してみたのでそのときのメモです。 Unityのゲーム画面キャプチャはYoutubeとニコ動の方にアップしてあるのでぜひ見てください。 Youtube
ニコニコ動画 どんな感じでやったか &hellip;"> <meta name="keywords" content="">

	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="UNICORN SQUARE GARDEN" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script type="text/javascript" src="/javascripts/jquery.fancybox.pack.js"></script>

<script language="Javascript" type="text/javascript">
$(document).ready(
  function() {
    (function($) {
      $(".fancybox[data-content-id]").each(function() {
        this.href = $(this).data('content-id');
      });
      $(".fancybox").fancybox({
        beforeLoad: function() {
          var el, 
              id = $(this.element).data('title-id');

          if (id) {
            el = $('#' + id);

            if (el.length) {
              this.title = el.html();
            }
          }
          if ($(this).data('content')) {
            this.content = $(this).data('content');
          }
        },
        helpers: {
          title: {
            type: 'inside'
          }
        }
      });
    })(jQuery);
  }
);
</script>

	
</head>



<body>
	<header id="header" class="inner"><h1><a href="/">UNICORN SQUARE GARDEN</a></h1>
<h4>design and application portfolio.</h4>
<nav id="main-nav"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/archives">Archive</a></li>
	<li><a href="/about">About</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/archives">Archive</a></li>
	<li><a href="/about">About</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="https://www.google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:kosakasakas.github.io">
			</form>
		</div>
	</div>
</nav>


</header>

	<div id="content" class="inner"><article class="post">
	<h2 class="title">UnityでリアルタイムIBLしてみた</h2>
	<div class="entry-content"><p><img src="/images/unicorn/miku/res1.jpg" alt="miku_cap" /></p>

<p>Unityでリアルタイムにイメージベースドライティング(割と疑似ですが。)してみたのでそのときのメモです。</p>

<p>Unityのゲーム画面キャプチャはYoutubeとニコ動の方にアップしてあるのでぜひ見てください。</p>

<ul>
<li><a href="http://youtu.be/s_aLvJGbGII">Youtube</a></li>
<li><a href="http://www.nicovideo.jp/watch/sm24722663">ニコニコ動画</a></li>
</ul>


<h2>どんな感じでやったか</h2>

<p>とりあえず全部リアルタイムでやるのは無理なので、アンビエントは全部テクスチャベイク&amp;ライトマップして静的な物として扱います。
リアルタイムでやったのは今回はディフューズとスペキュラとシャドウにしぼってやりました。</p>

<p>すごく分かりやすい記事がたくさんあったので、参考にした記事とハマったところとかのメモをのせます。</p>

<p>環境とかは以下の物を使っています。</p>

<ul>
<li>Unity 4.5.4f1 (free版)</li>
<li>Blender 2.7.2a</li>
</ul>


<!-- more -->


<h2>初音ミクを踊らせてみよう</h2>

<p>これはMMDforMecanimを使いました。
<a href="http://stereoarts.jp/">http://stereoarts.jp/</a></p>

<p>こちらのドキュメントは非常に分かりやすいので、そのままチュートリアルを実行すれば、特にハマることなくUnityで初音ミクを動かす事は出来ると思います。</p>

<p>自分が今回使ったモデルとモーションは以下の物です。ありがとうございます。</p>

<p>モデル：Tda式Appendミク / Tdaさん</p>

<p><a href="https://bowlroll.net/file/4576">https://bowlroll.net/file/4576</a></p>

<p>音源：WAVEFILE/初音ミク fullver. / 名無しさん</p>

<p><a href="http://www.nicovideo.jp/watch/sm14257396">http://www.nicovideo.jp/watch/sm14257396</a></p>

<p>モーション：WAVEFILE fullver.モーション / hinoさん</p>

<p><a href="http://bowlroll.net/up/dl5983">http://bowlroll.net/up/dl5983</a></p>

<p>ちなみに、いろいろモデルを使ってみてTda式ミクに着地しました。</p>

<p>理由はトゥーンシェードを外した時に一番しっくりくる事、装備品とかがスペキュラとかをつけた時に映える事、他のモデルだとシェーディングした時のフェイスパーツのつなぎ目がアーティファクトとして目立つ事などです。</p>

<p>頂点数なんかも少なすぎず、いい感じでした。</p>

<h2>Unityのライトマップでクオリティをあげよう</h2>

<p><img src="/images/unicorn/miku/robo_lightmap.jpg" alt="miku_lightmap" /></p>

<p>Unityのfree版でも時間をかけてライトマップを作れば上図のようなかなりきれいな絵が出せます。</p>

<p>ただ、ライトマップを焼く場合はstaticなオブジェクトである事が前提なので、対象物はステージとかterrainみたいな固定されたものである必要があります。</p>

<p>もちろん、初音ミクみたいなごりごりに動くオブジェクトをリアルタイムレンダリングしたい場合はシャドウとか陰影が常に動くので特定のシーンに依存するようなライトマップを焼いてしまうと動かした時になんか変な感じになってしまう訳です。</p>

<p>今回は動かないステージ部分のライティングと、ミクのシャドウ意外のアンビエントはライトマップやらプリレンダリングやらで先にテクスチャに焼き付ける方法を取ります。</p>

<p>ライトマップに関してはこちらの記事が非常に参考になるので一読して見てください。
一気にクオリティの高い絵が出せるようになると思います。</p>

<p><a href="http://tsubakit1.hateblo.jp/entry/2014/09/14/170753">http://tsubakit1.hateblo.jp/entry/2014/09/14/170753</a></p>

<p>ハマりポイントとしてはライトマップの解像度を適切に設定しないとかなり荒っぽくなるので気をつけてください。</p>

<p>で、試しに初音ミクをライトマップでレンダリングしてみます。</p>

<p><img src="/images/unicorn/miku/miku_lightmap.jpg" alt="miku_lightmap" /></p>

<p>なんかすっごい微妙な感じになってます。</p>

<p>どんなにがんばってもこんな感じになってしまいます。
これは表示されていないポリゴンが遮蔽されてたり、本来離れたオブジェクトの陰が乗っちゃってたりしてこんな感じになってるんじゃないかなーと推測してます。</p>

<p>ポリゴン同士を離したり、パーツを分解してライトマップを作り直せればたぶん改善するんでしょうけど、MMDforMecanimで読み込んだ時点でUnity上ではパーツが分解できないみたいなので、Unity上での処理はあきらめました。</p>

<h2>Blenderでアンビエントオクルージョンをテクスチャに焼こう</h2>

<p>直接光やシーンに依存しない、間接光による陰影をアンビエントオクルージョンと言ったりするんですが、まじめにやると計算時間がすごくかかるので今回は先に述べたように、あらかじめ計算してテクスチャに焼いておく方法をとります。</p>

<p>Unity proではSSAOなどのリアルタイムアンビエントオクルージョン手法がデフォで入っているのですが、free版ではポストエフェクト処理全般が使えないので、自力で実装するか、テクスチャに焼いちゃうかしかないと思います。</p>

<p>Unity freeでSSAO実装できるんですかね？</p>

<p>で、オクルージョンを焼くんですが、当初はライトマップがいい感じなのでUnity上で焼いてしまおうと思ったんですが、さっきの図みたいにUnity上のミクだとアーティファクト乗りまくりなので、あきらめてBlenderでレンダリングする事にしました。</p>

<p>最近のBlenderには<a href="http://www.blenderguru.com/tutorials/introduction-to-cycles/">Cycles</a>というレンダラーが付いていて、かなり本格的なレンダリングができちゃいます。</p>

<p>しかもリアルタイムでプレビューが出来るので、調整もすごい楽。</p>

<p>Cyclesの使い方は以下のページを参考にしました。</p>

<p><a href="http://www.kitotan.com/944">http://www.kitotan.com/944</a>
<a href="http://seiga.nicovideo.jp/seiga/im2951328">http://seiga.nicovideo.jp/seiga/im2951328</a></p>

<p>解説通りに行くと以下のような絵が出せると思います。</p>

<p><img src="/images/unicorn/miku/miku_cycles.jpg" alt="cycles" /></p>

<p>ポイントとしては、アンビエントオクルージョンを描きたいので、光源は消す事。
光源を消してもCyclesは環境光をいい感じに醸し出してくれます。
その分暗いので、環境光は強めに設定してください。</p>

<p>環境光の強度はこんな感じで設定します。</p>

<p><a href="http://silverspirecg.blog119.fc2.com/blog-entry-36.html">http://silverspirecg.blog119.fc2.com/blog-entry-36.html</a></p>

<p>このレンダリング結果をミクのテクスチャにベイクします。</p>

<pre><code>【レンダータブ＞ベイク】
</code></pre>

<p>でベイクできます。
パーツごとに選択してベイクしてください。
ここで、クリアチェックボックは外しておかないとテクスチャに上書きされていかないので、気をつけてください。</p>

<p>ベイクしたテクスチャは口の中とか遮蔽で真っ暗になっているので適宜手書きで最終調整して出来上がりです。</p>

<p>出来上がったテクスチャはGitHubに上げたので、参考にしてください。</p>

<h2>UnityでIBLをしよう</h2>

<p>クオリティの高いアルベド＋アンビエントテクスチャが焼けたので、いよいよイメージベースドレンダリングをしていきます。</p>

<p>UnityのIBLはSkyshopというマテリアル群が有名で、AssetStoreから購入する事ができます。
しかし、結構高いので、今回は無料で手に入るマテリアルでがんばる事にします。</p>

<p>Luxというマテリアルシェーダを使用しました。
使用方法はこちらの記事を参考にしました。
githubのmasterブランチzipを使用しています。</p>

<p><a href="http://qiita.com/yasei_no_otoko/items/18bd1e4ed9abc6da8357">http://qiita.com/yasei_no_otoko/items/18bd1e4ed9abc6da8357</a></p>

<p>基本は上記の記事通りにセッティングすれば動きます。
ただ、デフォルトではディフューズ環境マップとスペキュラ環境マップが1種類しかなく、バックグラウンドの画像解像度も低いので、自作します。</p>

<p>画像のソースはこちらから頂きました。</p>

<p><a href="http://www.hdrlabs.com/sibl/archive.html">http://www.hdrlabs.com/sibl/archive.html</a></p>

<p>このサイトからHDR画像を落としてくると、ディフューズ画像も付いてくるのですが、試してみるとちょっとぼかしが足りなくて、ディフューズ感が足りないので手動でもっとぼかします。</p>

<p>カウスブラー40pxくらいぼかすとちょうどいい感じがしました。めっちゃ適当ですね。。</p>

<p>で、ハマったのが、HDR画像だと環境マップ化する時に緑色になっちゃって変な色合いになります。
たぶん設定をちゃんとやれば取り込めると思うんですが、思考停止してjpgに変換してUnityで環境マップを作りました。</p>

<p>TextureTypeはRefrection、MappingはCylindricalでマップを作成します。</p>

<p>最終的な環境マップはgithubに上げておきました。</p>

<h2>リアルタイムソフトシャドウを出そう</h2>

<p>Unity free版のシャドウはほんとひどいです。</p>

<p>ハードシャドウしか出せない上に、初期設定のシャドウマップ解像度が低すぎてめっちゃジャギってます。</p>

<p>これもproならちゃんとソフトシャドウをリアルタイムに出してくれるのに、ほんとずるい。</p>

<p>てなわけで、ソフトシャドウはがんばって実装します。
参考文献はこちら</p>

<p><a href="http://unitycoder.com/blog/2014/07/15/unity-indie-soft-shadows-directional-light/">http://unitycoder.com/blog/2014/07/15/unity-indie-soft-shadows-directional-light/</a></p>

<p>コードはGitHubに上がってます。</p>

<p>簡単に言うと、Percentage Closer Filteringの簡易版見たいな感じで、AutoLightを改造して四方にサンプリングしたものになります。
デフォルトのクラスを改造しているのでフォルダを丸ごとぶっ込んで使ってください。</p>

<p>また、このシェーダはUnityでベイクしたライトマップの結果と互換性を持たせてあります。
なので、今回の初音ミク動画のシーンの静的オブジェクトに関しては、ライトマップをかけたあと、ミクのソフトシャドウが乗っているって感じです。</p>

<p><img src="/images/unicorn/miku/res3.jpg" alt="miku_res3" /></p>

<p>ゆーてカーペットしかレンダリングされてないんですけどね笑
ソフトシャドウがちゃんと出ている事を確認できると思います。</p>

<h2>結果と課題</h2>

<p><img src="/images/unicorn/miku/res2.jpg" alt="miku_res2" /></p>

<p>動画の方が分かりやすいかと思いますが、シーンによってミクの陰影がほんのり色づいているのが分かるかと思います。</p>

<p>目とか髪の毛のスペキュラも環境の映り込みがばっちり移ってます。</p>

<p>これがIBLの効果であり、60FPSで動きます。</p>

<p>そんな重い処理していないので当たり前ですが。。</p>

<p>カメラの動きとか光源の動きにも対応できるので、色々応用は出来るのではないかと思います。任意の写真で対応できるので、ARとか面白いかも。</p>

<p>今回は手抜きでSSSとか実装していないので、手が空いたらやってみます。
被写界深度とかモーションブラーとか、ポストエフェクト系もやりたい。</p>

<h2>今回のアセット</h2>

<p>使用したアセットは以下から入手可能です。
適当にZIPダウンロードしてください。</p>

<p>また、利用する場合は各種READMEをご覧ください。
よろしくお願いします。</p>

<p><a href="https://github.com/kosakasakas/UnityIBLAssets">GitHub &ndash; UnityIBLAssets</a></p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-10-18T01:24:56+09:00" pubdate data-updated="true">Oct 18<span>th</span>, 2014</time></div>
	

<div class="tags">

	<a class='category' href='/blog/categories/unity/'>Unity</a>, <a class='category' href='/blog/categories/rendering/'>rendering</a>

</div>


	
</div></article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
	
<!---	<a class="addthis_counter addthis_pill_style"></a> --->
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



<section id="comment">
    <h2 class="title">Comments</h2>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
	<footer id="footer" class="inner">Copyright &copy; 2014

    kosakasakas

<br>
Powered by Octopress.
</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'unicorngardensquare';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://kosakasakas.github.io/blog/2014/10/18/unity-realtime-ibl/';
        var disqus_url = 'http://kosakasakas.github.io/blog/2014/10/18/unity-realtime-ibl/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-55875834-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>
